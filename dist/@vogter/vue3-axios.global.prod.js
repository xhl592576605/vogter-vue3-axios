/*!
  * @vogter/vue3-axios v0.0.2
  * (c) 2021 @vogter/vue-axios axios's extend
  * @license MIT
  */
var VogterVueAxios=function(e,t){"use strict";function r(e){return e&&"object"==typeof e&&"default"in e?e.default:e}var i=r(e),a=r(t);function n(e,t){if(1===arguments.length&&(t=e,e=void 0),!t)return()=>{};t.includes("return")||(t="return "+(t=t.replace(/^\s*/g,"")));try{return e?new Function(...e,t):new Function(t)}catch(e){throw console.warn("函数解析失败",`'${t}'`),new Error(`函数解析失败:${t}'`)}}const o={};function s(e){return new Promise((t=>{o[e]?t(o[e]):"function"==typeof e?t(e()):/(\.json)$/.test(e)?i.get(e,{baseURL:""}).then((r=>{t(o[e]=r.data)})):/^(api|\/api)/.test(e)?i.get(e).then((r=>{t(o[e]=r.data.data)})):/(\.js)$/.test(e)?window.require([e],(e=>{t(e)})):"[object Object]"===Object.prototype.toString.call(e)?t(e):t(n("",e)())}))}class c{static $isObject(e){return"[object Object]"===Object.prototype.toString.call(e)}static $isArray(e){return Array.isArray(e)}static $isString(e){return"string"===(e instanceof String||(typeof e).toLowerCase())}static $isFunction(e){return"function"==typeof e}static $checkSpecialKey(e){if(e){const r='~!@#$%^&*+{}|"<>?';for(var t=0;t<e.length;t++)if(-1!==r.indexOf(e.substr(t,1)))return!1;return!0}return!0}}var p,l,h=(function(e,t){e.exports=function(){function e(){for(var e=0,t={};e<arguments.length;e++){var r=arguments[e];for(var i in r)t[i]=r[i]}return t}function t(e){return e.replace(/(%[0-9A-Z]{2})+/g,decodeURIComponent)}return function r(i){function a(){}function n(t,r,n){if("undefined"!=typeof document){"number"==typeof(n=e({path:"/"},a.defaults,n)).expires&&(n.expires=new Date(1*new Date+864e5*n.expires)),n.expires=n.expires?n.expires.toUTCString():"";try{var o=JSON.stringify(r);/^[\{\[]/.test(o)&&(r=o)}catch(e){}r=i.write?i.write(r,t):encodeURIComponent(String(r)).replace(/%(23|24|26|2B|3A|3C|3E|3D|2F|3F|40|5B|5D|5E|60|7B|7D|7C)/g,decodeURIComponent),t=encodeURIComponent(String(t)).replace(/%(23|24|26|2B|5E|60|7C)/g,decodeURIComponent).replace(/[\(\)]/g,escape);var s="";for(var c in n)n[c]&&(s+="; "+c,!0!==n[c]&&(s+="="+n[c].split(";")[0]));return document.cookie=t+"="+r+s}}function o(e,r){if("undefined"!=typeof document){for(var a={},n=document.cookie?document.cookie.split("; "):[],o=0;o<n.length;o++){var s=n[o].split("="),c=s.slice(1).join("=");r||'"'!==c.charAt(0)||(c=c.slice(1,-1));try{var p=t(s[0]);if(c=(i.read||i)(c,p)||t(c),r)try{c=JSON.parse(c)}catch(e){}if(a[p]=c,e===p)break}catch(e){}}return e?a[e]:a}}return a.set=n,a.get=function(e){return o(e,!1)},a.getJSON=function(e){return o(e,!0)},a.remove=function(t,r){n(t,"",e(r,{expires:-1}))},a.defaults={},a.withConverter=r,a}((function(){}))}()}(l={path:p,exports:{},require:function(e,t){return function(){throw new Error("Dynamic requires are not currently supported by @rollup/plugin-commonjs")}()}},l.exports),l.exports);const u=i.CancelToken;class f{constructor(e={}){this._serviceKeys=null,this._token=null,this._myServiceConfig={},this.axiosObj=null,this.apiCancelToken={},this._serviceKeys=e.serviceKeys||null,this._token=e.token||null,this._tokenKey=e.tokenKey||"__token__",this._myServiceConfig=e._myServiceConfig||{},e.overrideMethod&&c.$isObject(e.overrideMethod)&&Object.entries(e.overrideMethod).forEach((([e,t])=>{this[e]&&"function"==typeof this[e]&&"function"==typeof t&&(f.prototype[e]=t)})),this.$loadServicesConfig()}async $loadServicesConfig(){let e=this._serviceKeys||[];const t=this._myServiceConfig;let r=e.length,i=null,a=null,n=null;for(let o=0;o<r;o++)i=e[o],a=s(i),n=await a,Object.assign(t,n)}$getServiceConfig(e,t=[],r=0){if(r>=t.length)return null;const i=e.split(".");let a=null;if(i.forEach((e=>{a=a?a[e]:t[r][e]})),!a){a=this.$getServiceConfig(e,t,r+1)}return a}$getService(e={}){let t=this.axiosObj;if(!t){const r=window.$service_global||{};Object.assign(r,e),t=i.create(r),t.interceptors.request.use((e=>(this.$setRequestHeaders(e),e)),(e=>(console.warn("[@vogter/vue3-axios] 发起接口请求出现异常！"),console.warn(e),Promise.reject(e)))),t.interceptors.response.use((e=>Promise.resolve(e)),(e=>(this.$axiosRespErrorHook(e),Promise.resolve(e)))),this.axiosObj=t}return t}$setRequestHeaders(e){if(e.certificate){const t=this._token||h.get(this._tokenKey);Object.entries({Author:e.author,Authorization:t,"X-Http-Method-Override":e._method,"Cache-Control":"no-cache","Cache-control":"no-store",Pragma:"no-cache",Expires:1}).forEach((([t,r])=>{r&&(e.headers[t]=r)}))}else e.headers["X-Http-Method-Override"]=e._method,e.headers.Author=e.author;return e}$cancelFetchApi(e){const t=this.apiCancelToken||{};let r={};for(var i in"string"===(e instanceof String||(typeof e).toLowerCase())&&"[object Object]"===Object.prototype.toString.call(t[e])?r[e]=t[e]:r=t,r)"[object Object]"===Object.prototype.toString.call(t[e])&&r[i].abort(),t[i]=null}$disposeAxios(){this.axiosObj&&(this.axiosObj=null)}$axiosRespErrorHook({}={}){}$newCancelToken(e){const t=this;return new u((r=>{t.apiCancelToken||(t.apiCancelToken={}),t.apiCancelToken[e]=r}))}$fetchData(e,t,r){const i=this.$getService(r),a=this.$getServiceConfig(e,[this._myServiceConfig||{},window.$vogter.$service_config||{}],0);if(!a)throw console.warn('[@vogter/vue3-axios] api.json配置例子：\n\n        {\n            "system": {\n              "system": {\n                "remark": "login api",\n                "author": "author",\n                "method": "get",\n                "url": "/api/v1/login",\n                "params": {}\n              }\n            }\n        }'),new Error(`【${e}】接口未配置，请前往服务器根目录下的api配置文件(/api.json)中进行配置！`);const n=Object.assign({params:{},cancelToken:this.$newCancelToken(e)},a,t),{debug:o}=window.$vogter||{};o&&(n.params.debug=!0);return i(n)}$fetchDataByUrl(e,t,r){if(!e||!e.length)throw new Error("【url】参数未配置！");const i=this.$getService(r),a={url:e},n=Object.assign({params:{},cancelToken:this.$newCancelToken(e)},a,t),{debug:o}=window.$vogter||{};o&&(n.params.debug=!0);return i(n)}}function $(e,t){const r=[];return(e=e||[]).forEach((e=>{Array.isArray(e)?r.push($(e,t)):c.$isObject(e)?r.push(d(e,t)):r.push(g(e,t))})),r}function d(e,t){const r={};return Object.entries(e).forEach((([e,i])=>{r[e]=Array.isArray(i)?$(i,t):c.$isObject(i)?d(i,t):g(i,t)})),r}function g(e,t){let r=e||null;if(r){const e=-1===r.indexOf("@"),i=r.replace(/{/g,"@").replace(/}/g,"@").split("@");if(Array.isArray(t)){const a=[];i.forEach(((i,n)=>{if(a.push(!1),i&&i.length>0){const o=i.split(".");o.length>0&&t.forEach((t=>{if(!a[n]){const s=_(t,o,0,e);null!==s&&(a[n]=!0,r=e?r.replace(["{",i,"}"].join(""),s):s)}}))}})),a.forEach(((t,a)=>{const n=i[a];!t&&n&&n.length>0&&(r=e?r.replace(["{",n,"}"].join(""),""):null)}))}else i.forEach((i=>{if(i&&i.length>0){const a=i.split(".");if(a.length>0){const n=_(t,a,0,e);r=null!==n?e?r.replace(["{",i,"}"].join(""),n):n:e?r.replace(["{",i,"}"].join(""),""):null}}}))}return r}function _(e,t,r,i=!0){let a=null;if(null!=e)if(r<t.length){const n=t[r],o=1*n;Number.isFinite(o)&&Array.isArray(e)&&e[o]?a=_(e[o],t,++r,i):n in e&&(a=_(e[n],t,++r,i))}else a=i&&Array.isArray(e)?e.join(","):e;return a}var m=Object.freeze({__proto__:null,$matchData4Array:$,$matchData4Object:d,$matchData4String:g});class y{constructor(e,t,r){y.__apiService__=e,y.__app__=t,y.__$app__=r,this.$initApp()}static $getAppPropsMustValue(e){return Reflect.has(y.__app__.$props,e)||console.error(`[@vogter/vue3-axios] use ComponentsApiService's components must  has [${e}] props `),Reflect.get(y.__app__.$props,e)}static $getAppPropsValue(e){return Reflect.get(y.__app__.$props,e)}static $initComponentsApiService(e){e.$setApiParams&&e.$setApiParams(),e.$setUiParams&&e.$setUiParams()}$initApp(){return this.$initAppProps().$initAppData().$initAppWatch().$initAppComputed()}$initAppProps(){const e={props:{api:{type:[Object,Array]},filter:{type:Object},formatRules:{type:Array},cacheApiKey:{type:String,default:()=>"default"},apiSuspend:{type:Boolean,default:()=>!1}}};return y.__demo_props__=e,this}$initAppData(){return Object.assign(y.__app__.$data,{apiDataStore:{ready:!1,apiReadyCount:0,fetchDatas:[]},apiDataList:null,isApiFirstFetched:!0,myFilter:{},apiParams:{},uiParams:{}}),this}$initAppWatch(){const e=y.__app__;return e.$watch((()=>a.cloneDeep(e.filter)),((e,t)=>{this.$setApiParams(),this.$setUiParams()}),{deep:!0,immediate:!1}),e.$watch((()=>a.cloneDeep(e.myFilter)),((e,t)=>{this.$setApiParams(),this.$setUiParams()}),{deep:!0,immediate:!1}),e.$watch((()=>a.cloneDeep(e.apiParams)),((t,r)=>{if(a.isEqual(t,r))return;let{isApiFirstFetched:i,apiSuspend:n}=e;i?(i=!1,this.$fetchApiData(t,n)):this.$fetchApiData(t)}),{deep:!0,immediate:!1}),e.$watch((()=>a.cloneDeep(e.uiParams)),((t,r)=>{if(a.isEqual(t,r))return;if(e.apiSuspend)return;c.$isFunction(e.$clearData)&&e.$clearData();((e.apiDataStore||{}).fetchDatas||[]).forEach((e=>{e.rendered=!1,this.$filterFetchDataByUi(e,t)}))}),{deep:!0,immediate:!1}),e.$watch((()=>a.cloneDeep(e.api)),((t,r)=>{a.isEqual(t,r)||this.$fetchApiData(e.apiParams)}),{deep:!0,immediate:!1}),this}$initAppComputed(){return this}$fetchApiData(e,t=!1){if(t)return;const r=y.__app__;if(c.$isFunction(r.$fetchApiData))return void r.$fetchApiData(e,t);const i=y.$getAppPropsValue("api");if(!i||0==i.length)return void console.warn("[@vogter/vue3-axios] please in components set api props");c.$isFunction(r.$clearData)&&r.$clearData();const a=r.apiDataStore;a.fetchDatas=[],a.ready=!1,a.apiReadyCount=0,this.$onFetchData(i,e)}async $onFetchData(e,t){if(!e||0===e.length)return;c.$isObject(e)&&(e=[e]);const r=e.length;for(let i=0;i<r;i++){const r=e[i];if(!r.apiMethod&&!r.apiUrl)return;await this.$oneFetchData(r,i,t)}}async $oneFetchData(e,t,r){const i=y.__app__,a=y.__apiService__,{apiMethod:n,apiUrl:o,subApis:s,respMatch:p}=e;let l=this.$getApiOptions(e,r);const h=c.$isFunction(i.$beforeFetch)&&await i.$beforeFetch(l,e,r);l=h||l;let u={};n&&n.length>0?u=await a.$fetchData(n,l,{}).catch((t=>{c.$isFunction(i.$fetchApiError)&&i.$fetchApiError({api:e,apiMethod:n,apiOpt:l,error:t})})):o&&o.length>0&&(u=await a.$fetchDataByUrl(o,l,{}).catch((t=>{c.$isFunction(i.$fetchApiError)&&i.$fetchApiError({api:e,apiUrl:o,apiOpt:l,error:t})})));let f=this.$handleFetchApiData(u,p);const $=e=>{i.apiDataStore.fetchDatas.push(e),c.$isFunction(i.$everyFetched)?i.$everyFetched(e):this.$everyFetched(e)};if(f.length>0&&s&&s.length>0){const e=s.length;for(let i=0;i<e;i++){const a=s[i];f=await this.$fetchSubApi(f,a,r),i+1===e&&$({data:f,rendered:!1,apiIndex:t})}}else $({data:f,rendered:!1,apiIndex:t});this.$fetchFinished(t)}async $fetchSubApi(e,t,r){const i=y.__app__,a=y.__apiService__,n=this.$getSubApiOptions(e,t,r),{apiMethod:o,apiUrl:s,respMatch:p}=t;let l={};o&&o.length>0?l=await a.$fetchData(o,n,{}).catch((e=>{c.$isFunction(i.$fetchSubApiError)&&i.$fetchSubApiError({subApi:t,apiMethod:o,apiOpt:n,error:e})})):s&&s.length>0&&(l=await a.$fetchDataByUrl(s,n,{}).catch((e=>{c.$isFunction(i.$fetchSubApiError)&&i.$fetchSubApiError({subApi:t,apiUrl:s,apiOpt:n,error:e})})));let h=this.$handleFetchApiData(l,p);return h=await this.$mergeData(e,h,t),h}$getAllApiData(){const e=[];return((y.__app__.apiDataStore||{}).fetchDatas||[]).forEach((t=>{const{data:r}=t||{};r&&(c.$isArray(r)?e.push(...r):e.push(r))})),e}$everyFetched(e){this.$filterFetchDataByUi(e,y.__app__.uiParams)}$fetchFinished(e){const t=y.__app__,r=y.$getAppPropsMustValue("api"),i=t.apiDataStore;if(c.$isObject(r))i.apiReadyCount=1,i.ready=!0;else if(c.$isArray(r)&&i){let e=i.apiReadyCount||0;e++,i.apiReadyCount=e,i.ready=r.length===e}if(i.ready){c.$isFunction(t.$renderFetchData)&&t.$renderFetchData(i);const e=this.$getAllApiData();Object.assign(y.__app__.$data,{apiDataList:e})}}$filterFetchDataByUi(e={},t){const r=y.__app__,i=y.$getAppPropsValue("formatRules"),{data:a}=e;e.renderData=this.$filterData(a||[],t,i,null),c.$isFunction(r.$renderData)&&r.$renderData(e)}$setApiParams(){let e={};const t=y.__app__;e=a.merge(e,{isvogterAxios:!0});const{filter:r,myFilter:i}=t;return a.merge(e,r,i),t.$data.apiParams=Object.assign(t.$data.apiParams,e||{}),e}$setUiParams(){const e={},t=y.__app__,r=y.$getAppPropsValue("uiFilterMatch");if(r){let i={};for(const t in r){const a=r[t];a&&null!=i[a]&&(e[t]=i[a])}i=t.filter||{};for(const t in r){const a=r[t];a&&null!=i[a]&&(e[t]=i[a])}i=t.myFilter||{};for(const t in r){const a=r[t];a&&null!=i[a]&&(e[t]=i[a])}}return Object.keys(e).length>0&&(t.$data.uiParams=Object.assign(t.$data.uiParams,e||{})),e}$getApiOptions(e,t){const r=y.__app__;let{axiosOptions:i,queryParams:n,queryParamsMatch:o,bodyParams:s,bodyParamsMatch:c}=e,p={},l={};return o?(p=d(o,[t||{},r]),n=Object.assign({},n,p)):n=Object.assign({},n,t),c?c instanceof String||(typeof c).toLowerCase()?(l=g(c,[t||{},r]),s=l):(l=d(c,[t||{},r]),s=Object.assign({},s,l)):s&&(s=Object.assign({},s,t)),i=a.merge({},i,s?{params:n,data:s}:{params:n}),i}$getSubApiOptions(e,t,r){const i=this.$getApiOptions(t,r),{queryParamsRela:a,bodyParamsRela:n}=t;let{params:o,data:s}=i;o||(o=i.params={});for(const t in a){const r=a[t],i=[];e.forEach((e=>{const t=e[r];null!=t&&i.push(t)})),i.length>0&&(o[r]=i.join(","))}s||(s=i.data={});for(const t in n){const r=n[t],i=[];e.forEach((e=>{const t=e[r];null!=t&&i.push(t)})),i.length>0&&(s[r]=i.join(","))}return i}$filterData(e,t,r,i){let a=e||[];const n={};for(const e in t)null!=t[e]&&""!==t[e]&&(n[e]=t[e]);r=r||[];const o=Object.entries(n),s=(e,r)=>{let i=!0;if(Array.isArray(r))for(let e=0,t=r.length;e<=t&&(i=s(e,r[e]),!i);e++);else if(c.$isObject(r)){for(const e in r)if(i=s(e,r[e]),i)break}else if(null!=t[e]){let e=!1;o.forEach((([t,a])=>{c.$isArray(a)?(a.forEach((t=>{e=e||t.indexOf(r)>-1||r.indexOf(t)>-1})),i=e):"string"==typeof r?i=i&&(r.indexOf(a)>-1||a.indexOf(r)>-1):"number"==typeof r?(r=r.toString(),i=i&&(r.indexOf(a)>-1||a.indexOf(r)>-1)):i=i&&a===r}))}else i=!1;return i};if(o.length>0||r.length>0){a=[];for(let t=0,i=e.length-1;t<=i;t++){r.forEach((e=>{}));let i=!0;o.length&&(i=s(t,e[t])),i&&a.push(e[t])}}return a}async $mergeData(e,t,r){const i=y.__app__;e=e||[],t=t||[];const n=(r=r||{}).mergeRelations,o=r.mergeTargetKey||"",s=c.$isObject(n)?[n]:n||[];if(0===e.length||0===t.length)return e;let p=c.$isFunction(i.$beforeMerge)?await i.$beforeMerge(e,t,s,r):void 0;if(!1!==p){p=p||e||[],s.forEach((e=>{if(e){const n=Object.entries(e);let s={};r.mergeKey?t.forEach((t=>{const i=Object.keys(e),a=[];i.forEach((e=>{a.push(t[e])}));const n=a.join("_");s[n]=s[n]||{},s[n][r.mergeKey]=s[n][r.mergeKey]||[],s[n][r.mergeKey].push(t)})):s=a.keyBy(t,(e=>{const t=[];return n.forEach((([r,i])=>{e[r]&&t.push(e[r])})),t.join("_")}));let l=p;o&&o.length>0&&(l=c.$isArray(p)?p[0][o]:p[o]),l.forEach((t=>{const r=[];n.forEach((([e,i])=>{t[i]&&r.push(t[i])}));const o=s[r.join("_")];c.$isFunction(i.$afterMerge)&&i.$beforeEveryMerge(t,o,e),o&&a.merge(t,o),c.$isFunction(i.$afterEveryMerge)&&i.$afterEveryMerge(t,o,e)}))}}));const n=c.$isFunction(i.$afterMerge)&&await i.$afterMerge(p,t,s,e);n&&(p=n)}return p}$handleFetchApiData(e,t="@data.data@"){let r=g(t,e||{});return c.$isArray(r)||(r=[r]),r}static $renderDataDemo(e){const{rendered:t=!1,renderData:r=[]}=e;!0!==t&&r&&r.length>0&&(e.rendered=!0)}static $renderFetchDataDemo(e){const{fetchDatas:t=[]}=e;t.forEach((e=>{const{rendered:t=!1,renderData:r=[]}=e;!0!==t&&r&&r.length>0&&(e.rendered=!0)}))}}let A=null;class v{constructor(e){this.computed={$apiServiceOpts:()=>({overrideMethod:{}})},A=e}data(){return{$apiService:null}}created(){this.$apiService=new f(this.$apiServiceOpts),this.$props.enableCompApiService&&(this.$data.$componentsApiService=new y(this.$apiService,this,A))}mounted(){this.$props.enableCompApiService&&this.$nextTick((()=>{this.$data.$componentsApiService&&y.$initComponentsApiService(this.$data.$componentsApiService)}))}beforeDestory(){this.$apiService.$cancelFetchApi(),this.$apiService.$disposeAxios()}}const b={...m,$loadConfig:s,$string2function:n,$dtaCheck:c};return{install:(e,t)=>{Object.entries(b).forEach((([t,r])=>{e.config.globalProperties[t]=r})),window.$vogter||(window.$vogter={}),window.$vogter.$apiService=new f,b.$loadConfig("/api.json").then((e=>{window.$vogter.$service_config=e})),e.mixin(new v(e))}}}(axios,_);
